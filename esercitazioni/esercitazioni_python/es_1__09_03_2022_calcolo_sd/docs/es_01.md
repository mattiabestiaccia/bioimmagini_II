# üìù Esercitazione 1 (09/03/2022)

---

## üìö Teoria

### Misura del Rumore (Noise Measurement)

La misura del rumore associato ad un'immagine biomedica √® un punto fondamentale in molte applicazioni, come l'analisi della qualit√† di immagine e la realizzazione di filtri adattivi. Per la misura del rumore sono stati sviluppati vari approcci, che possono essere divisi in due categorie:

* Basati sul tracciamento di ROI (Region of Interest).
* Basati sull'analisi dell'istogramma.

#### Metodi Basati su ROI

Nei metodi basati su ROI, una o pi√π ROI vengono tracciate sui tessuti di interesse, definendo delle zone omogenee e evitando che la misura sia influenzata dal PVE (Partial Volume Effect) o dalla presenza di attenuazione.

* Il rumore sul tessuto viene stimato come la **deviazione standard (SD)** del segnale sulla ROI.
* Le ROI possono essere definite manualmente o automaticamente attraverso algoritmi di segmentazione. La definizione automatica √® semplificata nel caso di fantocci per la misura della qualit√† dell'immagine, di cui √® nota la forma e posizione nello scanner.
* Nella misura attraverso ROI, il punto fondamentale √® il **compromesso tra grandezza della ROI e necessit√† di posizionare la ROI in una regione omogenea**.

**Esempio di Misura in funzione della Dimensione della ROI:**

La figura seguente mostra le misure di Media e SD del segnale su ROI di dimensioni crescenti (100 realizzazioni di rumore, ROI quadrate con lato uguale alla dimensione indicata).

Si osserva chiaramente come la misura della **SD sia pi√π critica** rispetto a quella del valor medio e come siano necessarie ROI con qualche centinaio di pixel per avere una misura affidabile. Da queste considerazioni derivano gli approcci a sottrazione di immagini e misura del rumore sul fondo utilizzati nella pratica clinica con lo scopo di aumentare il numero di pixel disponibili per la stima della SD.

**Esempio in Immagini Cardiache (LGE - Late Gadolinium Enhancement):**

Consideriamo ad esempio il caso in figura di immagini cardiache in LGE. Lo scopo di questo tipo di immagini con contrasto √® verificare l'estensione dell'infarto miocardio cronico, dove si deposita il contrasto, che appare bianco, mentre il miocardio sano appare con segnale annullato (in realt√† avremo sempre un segnale diverso da zero per la natura del rumore MR).


[Image of cardiac MR images in LGE]

Per valutare la validit√† clinica delle immagini bisogna valutare il **CNR (Contrast-to-Noise Ratio)** tra la zona di LGE (cicatrice da infarto, ROI 1) ed il miocardio sano (ROI 2). Come si vede, le regioni in cui tracciare le ROI sono molto piccole (es. area LGE di 26 pixel, area miocardio di 60 pixel circa).

La misura della SD sar√† quindi inaffidabile. √à molto pi√π affidabile una misura fatta nello sfondo (Background, BK) che permette di tracciare una ROI con molti pi√π pixel (es. 1550 pixel circa). In questo caso, essendo il miocardio annullato (segnale zero), il valore di CNR sar√†:
$$CNR = \frac{2(M_{LGE} - M_{MiO})}{SD_{BK} + 1.526 \cdot SD_{BK}}$$

#### Metodi Basati sull'Analisi dell'Istogramma

I metodi basati sull'analisi dell'istogramma cercano invece di caratterizzare il rumore dall'immagine nel suo complesso. In questo caso si utilizza tutta l'informazione contenuta nell'immagine per cui il problema visto nelle ROI non si pone.

Consideriamo una immagine ideale a sei pattern corrotta da rumore gaussiano ed il suo istogramma:


Se tracciamo una ROI all'interno di un pattern, la SD del segnale nella ROI sar√† sempre la stessa, dipendendo dal rumore sommato all'immagine. Se invece tracciamo una ROI a cavallo di due pattern, misureremo un valore pi√π alto dovuto alla presenza di due tessuti con segnali diversi all'interno della ROI.

Automatizzando la procedura, possiamo far scorrere sull'immagine un **kernel** (ad esempio 5x5) che rappresenta la ROI e valutare il valore della deviazione standard SD sulla regione di immagine coperta dal kernel (in MATLAB con la funzione `stdfilt`). Si otterranno quindi un numero di valori di SD uguale al numero di pixel dell'immagine, formando una **mappa SD**.

Nelle regioni all'interno dei pattern uniformi, il valore della SD sar√† pari alla deviazione standard del rumore ($\sigma$), almeno nel caso di rumore gaussiano additivo. Nelle regioni a cavallo di due pattern, il valore di SD sar√† maggiore di $\sigma$. La dimensione del kernel rappresenta un compromesso tra l'esigenza di calcolare correttamente la SD e la necessit√† di avere la maggior parte delle misure eseguita su regioni omogenee.

L'istogramma della mappa SD avr√† un **picco in corrispondenza del valore di $\sigma$** e una serie di valori pi√π alti corrispondenti alle transizioni.

**Metodi di Stima del Rumore ($\sigma$):**

1.  **Media della Mappa SD ($\sigma = \text{mean}(M_{SD})$):** Se l'immagine √® composta prevalentemente da regioni omogenee, si pu√≤ supporre che il contributo delle regioni di transizione sia trascurabile.
2.  **Mediana della Mappa SD ($\sigma = \text{median}(M_{SD})$):** In realt√†, √® preferibile eliminare gli *outliers* dovuti ai bordi e computare la mediana della mappa SD, cosa che consente di ottenere una stima pi√π accurata. Infatti, al contrario della media, la mediana pesa meno gli alti valori di SD nella parte destra dell'istogramma.
3.  **Massimo dell'Istogramma della Mappa SD ($\sigma = x: h(x) = \text{max}(h)$):** Se l'immagine presenta molte transizioni, il metodo della mediana pu√≤ dare risultati non corretti. In questo caso √® possibile utilizzare l'istogramma calcolando il valore di $\sigma$ dal picco principale (tipicamente il primo), che contiene l'informazione sulle regioni omogenee. $\sigma$ √® dato dalla posizione sull'asse x del massimo valore dell'istogramma $h$.



* Il metodo Mean sovrastima il valore del rumore, mentre gli altri due metodi danno una stima sostanzialmente corretta.
* Questi metodi si basano sull'assunzione di **rumore gaussiano additivo**.

#### Rumore in Immagini MR

Se l'assunzione di rumore gaussiano non √® verificata, bisogna operare sulla base della conoscenza del processo di acquisizione.

**Esempio di Phantom Cilindrico in Risonanza Magnetica (MR):**

Consideriamo l'immagine MR di un phantom cilindrico, composto da tre cilindri concentrici, due riempiti con acqua e quello intermedio con olio (valore di segnale pi√π alto). Essendo il fantoccio riempito con liquido perfettamente omogeneo, il rumore biologico √® trascurabile e l'attenuazione pu√≤ essere considerata nulla.

Alcuni pixel dell'immagine non sono stati ricostruiti dal K-spazio ma rappresentano un "riempimento" (zero-padding), a cui viene assegnato il valore convenzionale 0 e devono essere ignorati nell'elaborazione.

* Il valore di $\sigma$ pu√≤ essere stimato tracciando una ROI su un tessuto omogeneo oppure sul fondo, introducendo un opportuno **fattore di correzione** (es. $1.526$) noto per le immagini MR.


* **Valori SD stimati (Esempio):**
    | Metodo | SD Bk | SD Bk Corr | SD Water | SD Oil |
    | :--- | :--- | :--- | :--- | :--- |
    | Manual | $9.6764$ | $14.7661$ | $13.1383$ | $14.6598$ |
    | Auto | | | | |

* Se si applicano i metodi automatici, si calcola la mappa SD e l'istogramma, eliminando i pixel a valore nullo.

* Il grafico mostra un singolo picco, che √® la combinazione dei valori di SD del fondo e di quelli dei due tessuti ad alto SNR.

* **Valori SD stimati con metodi automatici (Senza Segmentazione):**
    | Metodo | SD Mean | SD Median | Max Hist |
    | :--- | :--- | :--- | :--- |
    | 1 | $22.3108$ | $10.0968$ | $7.8155$ |

* Il calcolo della media sovrastima $\sigma$. La mediana √® simile alla SD del rumore di fondo. Il massimo dell'istogramma √® minore della SD del fondo. Tali valori non sono generalizzabili.
* In questo caso, √® necessario identificare le due classi di pixel attraverso un algoritmo di segmentazione (ad esempio, considerando solo i pixel con livello di grigio superiore a 100 per acqua e olio).



* **Valori SD stimati con metodi automatici (Con Segmentazione - soglia > 100):**
    | Metodo | SD Mean | SD Median | Max Hist |
    | :--- | :--- | :--- | :--- |
    | 1 | $69.5255$ | $15.7743$ | $12.3800$ |

* La stima con i metodi **Median** e **Max Hist migliora in modo significativo**.

**Conclusione Teoria:** Per la valutazione automatica del rumore nell'immagine biomedica occorre una scelta oculata dell'algoritmo sulla base delle caratteristiche dell'immagine.

---

## üíª Esercitazione (Consegne per Punti)

Lo scopo √® replicare le misure di qualit√† dell'immagine eseguite in un laboratorio MR su un fantoccio sferico (acquisito su una macchina MR Signa HDxt General Electric a 3 Tesla). Il campo `PatientID = 'geservice'` indica che le immagini sono state acquisite per un controllo di qualit√†.

* **Immagine 1:** Immagine 2D Fast Spin Echo del fantoccio.
* **Immagine di Rumore:** Immagine ottenuta sottraendo due acquisizioni dell'Immagine 1 (il segnale del fantoccio si annulla).



### 1. Calcolo del Rapporto Segnale Rumore (SNR)

Realizzare un programma MATLAB che implementi la procedura del protocollo CONSIP per il calcolo dell'SNR (che in realt√† misura il CNR tra il fantoccio e il fondo), assicurando che vengano rispettate le indicazioni sulle dimensioni delle ROI.

**Procedura Protocollo CONSIP:**

1.  **ROI Segnale ($ROI_{75\%}$):** Sull'**Immagine 1**, disegnare una ROI (es. con `getrect` o `drawrectangle`) al centro dell'area del segnale, di dimensioni pari al **75% di quest'area**. Determinare il **valor medio** dell'intensit√† dei pixel.
2.  **ROI Baseline ($ROI_{10\%}$):** Sull'**Immagine 1**, disegnare una ROI in una zona priva di segnale e artefatti (es. in un angolo), di dimensioni pari al **10% dell'area che produce segnale**. Calcolare il **valor medio** (baseline).
3.  **Calcolo del Segnale ($S$):** Sottrarre i due valori medi:
    $$S = (\text{Valor medio } ROI_{75\%}) - (\text{Valor medio } ROI_{10\%})$$
4.  **Immagine di Rumore:** L'immagine di rumore √® gi√† disponibile.
5.  **Calcolo del Rumore ($N$):** Trasferire la $ROI_{75\%}$ nell'**Immagine di Rumore** (stessa posizione) e calcolare il rumore $N$ come la **deviazione standard (SD)** dell'intensit√† dei pixel.
6.  **Calcolo dell'SNR:**
    $$SNR = \sqrt{2} \times \frac{S}{N}$$

### 2. Calcolo dell'Uniformit√† di Segnale (UH)

Realizzare un programma MATLAB che implementi la procedura per il calcolo dell'Uniformit√† (UH), assicurando che vengano rispettate le indicazioni sulle dimensioni delle ROI.

**Procedura Protocollo CONSIP:**

1.  **ROI per Uniformit√†:** Utilizzare l'Immagine 1. Disegnare una ROI **centrale pari all'80%** dell'area che produce segnale.
2.  **Determinare la Deviazione Media Assoluta (AAD - Average Absolute Deviation) nella ROI** come:
    $$AAD = \frac{\sum_{i}^{N} |S_{i} - S_{mean}|}{N}$$
    Dove $S_{i}$ √® il valore di ogni singolo pixel nella ROI e $S_{mean}$ √® il valore medio nella ROI.
3.  **Calcolare l'Uniformit√† (UH):**
    $$UH = 1 - \frac{AAD}{S_{mean}}$$
    * $AAD$ √® uguale a zero se l'immagine √® perfettamente uniforme, e quindi in questo caso $UH=1$.

### 3. Valutazione dell'Acutezza della Transizione (PVE)

Valutare la presenza di PVE sull'Immagine 1 del fantoccio calcolando l'acutezza della transizione.

**Procedura:**

1.  **Definire un Profilo:** Definire un profilo (segmento) sull'immagine che intersechi una transizione ed estrarre il grafico del valore di segnale sul profilo.

2.  **Calcolare l'Acutezza ($A$):** Implementare il calcolo dell'acutezza utilizzando l'approssimazione per l'immagine discreta:
    $$A = \frac{1}{f(b) - f(a)} \sum_{i=a}^{b} \left[ \frac{f(i+1) - f(i)}{d} \right]^{2}$$
    Dove $f$ √® il profilo estratto e $d$ √® la dimensione del pixel.
3.  **Automazione dei Punti $a$ e $b$:** Per ridurre la variabilit√† dovuta all'osservatore, automatizzare la definizione di $a$ (inizio transizione) e $b$ (fine transizione). Si pu√≤ convenire che $a$ e $b$ siano i punti in cui il segnale raggiunge rispettivamente il **10% e il 90% del suo valore massimo** ($S_m$).
    * Fissare le soglie: $0.1 \cdot S_m$ e $0.9 \cdot S_m$.

Dovrai realizzare quindi un programma MATLAB che implementi il calcolo dell'acutezza su di un profilo definibile dall'utente o calcolato in modo automatico.
√≤